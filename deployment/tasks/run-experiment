#!/usr/bin/env bash

# Run experiment slave - with no additional option

# ----------------------------------------------------------------------------------------------------------
# Prepare a device for the experiment
# ----------------------------------------------------------------------------------------------------------
# Obtain LGTC name - last 3 digits of node IP adresses
IPADDR=$(hostname -I)
IPADDR=${IPADDR#*"192.168.12."}
IPADDR=${IPADDR:0:3}

# Optain application location and filename
APP_LOC=$APP
APP_NAME=${APP:3}

echo "Deploying ${APP:3} application on node $IPADDR in slave mode"

# ----------------------------------------------------------------------------------------------------------
# Flash the device with corresponding binary file.
# ----------------------------------------------------------------------------------------------------------
# Locate .bin file for slave
BIN_FILE="/root/logatec-experiment/applications/${APP_LOC}/binary/slave.bin"

# Flash the UWB node with given application binaries
python3 snp_uwb_flash.py $BIN_FILE

# Rename logg file and move it to the results folder
mv flash_report.log flash_report_${IPADDR}.log
mv *.log /root/logatec-experiment/results/

# ----------------------------------------------------------------------------------------------------------
# Start the experiment application (storing the results into file with IPADDR in its name)
# ----------------------------------------------------------------------------------------------------------




# Wait untill the experiment is done - sleep for defined perion of experiment duration
#sleep ${APP_DUR}m

# Get device ID
#cd "/root/logatec-experiment/applications/${APP_LOC}"
#python3 uwb_getid.py $IPADDR
#mv *.txt /root/logatec-experiment/results/


#----- Run serial monitor on each device
cd "/root/logatec-experiment/applications/${APP_LOC}"
python3 uwb_monitor.py $IPADDR $APP_DUR
mv *.txt /root/logatec-experiment/results/
mv *.log /root/logatec-experiment/results/
#----- Run serial monitor on each device


# ----------------------------------------------------------------------------------------------------------
# Cleanup - Put UWB into reset state so it doesnt interfeer with other experiments
# ----------------------------------------------------------------------------------------------------------
cd /root/logatec-experiment/deployment/tasks
python3 snp_uwb_poweroff.py
